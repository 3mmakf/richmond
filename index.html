<script>
  (function () {
    const CHECKS_KEY   = 'rcw_checks_v1';
    const DAYS_KEY     = 'rcw_days_v1';
    const TASK_DAY_KEY = 'rcw_task_days_v1';
    const PHOTOS_KEY   = 'rcw_photos_v1';

    function loadState(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : (fallback ?? null);
      } catch (e) {
        console.error('Error loading state for', key, e);
        return fallback ?? null;
      }
    }

    function saveState(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.error('Error saving state for', key, e);
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      const dayCards = Array.from(document.querySelectorAll('.day-card'));
      const dayLists = {};
      dayCards.forEach(card => {
        const id = card.dataset.dayId;
        const list = card.querySelector('.checklist');
        if (id && list) dayLists[id] = list;
      });

      const photoInput    = document.getElementById('photo-capture');
      const collageSect   = document.getElementById('photo-collage');
      const collageGrid   = document.getElementById('photo-collage-grid');
      const collageCaption = document.querySelector('.collage-caption');
      let   activePhotoTask = null;

      /* ===== PHOTOS (per-device) ===== */
      let photoState = loadState(PHOTOS_KEY, []);
      if (!Array.isArray(photoState)) photoState = [];

      function renderCollage() {
        if (!collageSect || !collageGrid) return;

        collageGrid.innerHTML = '';

        if (!photoState || photoState.length === 0) {
          // no photos yet
          const msg = document.createElement('p');
          msg.textContent = 'no photos yet — check something off and add one ✿';
          msg.style.fontSize = '0.8rem';
          msg.style.textAlign = 'center';
          msg.style.color = 'rgba(0,0,0,0.5)';
          collageGrid.appendChild(msg);
          if (collageCaption) {
            collageCaption.textContent = 'photos from the moments we checked off ✿';
          }
          return;
        }

        // sort oldest → newest
        const sorted = photoState.slice().sort((a, b) => (a.ts || 0) - (b.ts || 0));

        sorted.forEach(p => {
          if (!p || !p.dataUrl) return;
          const img = document.createElement('img');
          img.src = p.dataUrl;
          img.alt = p.label || 'memory photo';
          collageGrid.appendChild(img);
        });

        if (collageCaption) {
          const count = photoState.length;
          collageCaption.textContent =
            count === 1
              ? '1 little memory added ✿'
              : `${count} little memories added ✿`;
        }
      }

      renderCollage();

      if (photoInput) {
        photoInput.addEventListener('change', function () {
          const file = this.files && this.files[0];
          if (!file || !activePhotoTask) {
            this.value = '';
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            const dataUrl = e.target.result;
            if (!dataUrl) return;

            const newPhoto = {
              id: 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2),
              taskId: activePhotoTask.itemId,
              label: activePhotoTask.labelText,
              dataUrl: dataUrl,
              ts: Date.now()
            };

            photoState.push(newPhoto);
            saveState(PHOTOS_KEY, photoState);
            alert('Photo added to your collage! ✿'); // just to make it obvious
            renderCollage();
          };
          reader.readAsDataURL(file);

          activePhotoTask = null;
          photoInput.value = '';
        });
      }

      /* ===== RESTORE TASK MOVES ===== */
      let taskDayState = loadState(TASK_DAY_KEY, {});
      const allCheckboxes = Array.from(
        document.querySelectorAll('.check input[type="checkbox"]')
      );

      allCheckboxes.forEach((box) => {
        const itemId = box.dataset.itemId;
        if (!itemId) return;

        const savedDay = taskDayState[itemId];
        if (!savedDay || !dayLists[savedDay]) return;

        const li = box.closest('li');
        const currentCard = box.closest('.day-card');
        const currentDayId = currentCard ? currentCard.dataset.dayId : null;

        if (li && savedDay !== currentDayId) {
          dayLists[savedDay].appendChild(li);
        }
      });

      /* ===== CHECKBOX STATE (per-device) ===== */
      let checkState = loadState(CHECKS_KEY, {});
      allCheckboxes.forEach((box) => {
        const itemId = box.dataset.itemId;
        if (!itemId) return;

        if (Object.prototype.hasOwnProperty.call(checkState, itemId)) {
          box.checked = !!checkState[itemId];
        }

        box.addEventListener('change', () => {
          const wasChecked   = !!checkState[itemId];
          const isNowChecked = box.checked;

          checkState[itemId] = isNowChecked;
          saveState(CHECKS_KEY, checkState);

          // prompt for photo only when going from unchecked -> checked
          if (!wasChecked && isNowChecked && photoInput) {
            const labelEl = box.closest('.check')?.querySelector('.text');
            const labelText = labelEl ? labelEl.textContent.trim() : 'this moment';

            const ok = confirm(
              `Do you want to take a photo for:\n“${labelText}”?`
            );
            if (ok) {
              activePhotoTask = { itemId, labelText };
              photoInput.click();
            }
          }
        });
      });

      /* ===== COLLAPSIBLE DAYS (per-device) ===== */
      let dayState = loadState(DAYS_KEY, {});
      dayCards.forEach((card, cardIndex) => {
        const dayId = card.dataset.dayId || ('day_' + cardIndex);
        const toggleBtn = card.querySelector('.day-toggle');
        const content = card.querySelector('.day-content');
        if (!toggleBtn || !content) return;

        if (dayState[dayId]) {
          card.classList.add('collapsed');
        }

        function updateToggleLabel() {
          toggleBtn.textContent = card.classList.contains('collapsed')
            ? 'Show day ✿'
            : 'Hide details ✿';
        }

        toggleBtn.addEventListener('click', () => {
          card.classList.toggle('collapsed');
          dayState[dayId] = card.classList.contains('collapsed');
          saveState(DAYS_KEY, dayState);
          updateToggleLabel();
        });

        updateToggleLabel();
      });

      /* ===== MOVE TO ANOTHER DAY (per-device) ===== */
      dayCards.forEach(card => {
        const moveBtn = card.querySelector('.day-move');
        if (!moveBtn) return;

        moveBtn.addEventListener('click', () => {
          const allChecks = card.querySelectorAll('.check input[type="checkbox"]');
          const unchecked = Array.from(allChecks).filter(cb => !cb.checked);

          if (unchecked.length === 0) {
            alert('Everything in this day is already checked off! ✨');
            return;
          }

          let answer = prompt(
            'Move all UNCHECKED tasks from this day to which day?\n' +
            'Type: Tuesday, Wednesday, Thursday, Friday, or Saturday.'
          );
          if (!answer) return;

          answer = answer.trim().toLowerCase();

          let targetDay = null;
          if (answer.startsWith('tue')) targetDay = 'tuesday';
          else if (answer.startsWith('wed')) targetDay = 'wednesday';
          else if (answer.startsWith('thu')) targetDay = 'thursday';
          else if (answer.startsWith('fri')) targetDay = 'friday';
          else if (answer.startsWith('sat')) targetDay = 'saturday';

          if (!targetDay || !dayLists[targetDay]) {
            alert('I didn’t recognize that day. Try Tuesday, Wednesday, Thursday, Friday, or Saturday.');
            return;
          }

          unchecked.forEach((cb) => {
            const li = cb.closest('li');
            if (!li) return;
            dayLists[targetDay].appendChild(li);

            const itemId = cb.dataset.itemId;
            if (!itemId) return;
            taskDayState[itemId] = targetDay;
          });

          saveState(TASK_DAY_KEY, taskDayState);
        });
      });
    });
  })();
</script>



